<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBM Note</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            overscroll-behavior: none;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 700;
        }
        .form-input, .form-textarea, .form-select {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .btn-primary {
            @apply w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out;
        }
        .btn-secondary {
             @apply w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600 transition duration-150 ease-in-out;
        }
        .btn-tertiary {
            @apply bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-md hover:bg-gray-300 transition;
        }
        .card {
            @apply bg-white shadow-md rounded-lg p-4 mb-4 border border-gray-200;
        }
        /* 스크롤바 숨기기 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* 모달 스타일 */
        #company-code-modal {
            background-color: rgba(0,0,0,0.6);
        }
        
        .tbm-table th, .tbm-table td {
            @apply border border-gray-300 px-2 py-1 text-sm text-center;
        }
        .tbm-table th {
             @apply bg-blue-100 font-semibold;
        }
        .tbm-table input[type="text"], .tbm-table input[type="datetime-local"], .tbm-table textarea {
            @apply w-full border-none focus:ring-0 text-center p-1 bg-transparent;
        }
        .post-it {
            background: #fefcbf; /* Light yellow */
            box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            transform: rotate(-1.5deg);
            transition: transform 0.15s ease-in-out;
            margin-bottom: 1.5rem; /* Add margin to avoid overlap */
        }
        .post-it:hover {
            transform: rotate(0deg) scale(1.02);
            z-index: 10;
        }
        .comment-section {
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #cccccc;
        }

    </style>
</head>
<body class="bg-gray-100">

    <!-- 회사 코드 입력 모달 -->
    <div id="company-code-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <h2 class="text-xl font-bold mb-4">TBM Note 시작하기</h2>
            <p class="text-gray-600 mb-6">데이터를 안전하게 관리하기 위해<br>회사 코드를 입력해주세요.</p>
            <input type="text" id="company-code-input" placeholder="회사 코드를 입력하세요" class="form-input mb-4 text-center">
            <button id="company-code-submit" class="btn-primary">시작하기</button>
        </div>
    </div>

    <!-- 메인 앱 컨테이너 -->
    <div id="app-container" class="hidden h-screen flex flex-col">
        <!-- 헤더 -->
        <header class="bg-white shadow-md w-full p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600">TBM Note</h1>
            <div>
                <span id="display-company-code" class="text-sm text-gray-600 font-semibold mr-2"></span>
                <button id="change-company-btn" class="text-xs text-blue-500 hover:underline">변경</button>
            </div>
        </header>

        <!-- 탭 네비게이션 -->
        <nav class="bg-white shadow-sm">
            <div class="flex justify-around border-b border-gray-200">
                <button data-tab="tbm" class="tab-button flex-1 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent transition active">TBM 기록</button>
                <button data-tab="community" class="tab-button flex-1 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent transition">커뮤니티</button>
                <button data-tab="vote" class="tab-button flex-1 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent transition">투표</button>
                <button data-tab="meeting" class="tab-button flex-1 py-3 text-sm font-medium text-gray-500 border-b-2 border-transparent transition">미팅</button>
            </div>
        </nav>

        <!-- 탭 컨텐츠 -->
        <main id="tab-content" class="flex-grow p-4 overflow-y-auto no-scrollbar pb-24">
            <!-- TBM 기록 탭 -->
            <div id="tbm-content" class="tab-pane active">
                <div class="flex space-x-2 mb-4">
                    <button id="show-tbm-form-btn" class="flex-1 btn-primary">새 기록 작성</button>
                    <button id="show-tbm-list-btn" class="flex-1 btn-tertiary">기록 목록 보기</button>
                </div>

                <!-- TBM 기록 작성 폼 -->
                <div id="tbm-form-view">
                     <h3 class="text-xl font-bold mb-4 text-center">Tool Box Meeting 회의록</h3>
                     <form id="tbm-form" class="space-y-4">
                        <table class="w-full border-collapse border border-gray-300 tbm-table">
                            <tbody>
                                <tr>
                                    <th>TBM 일시</th>
                                    <td colspan="3"><input type="datetime-local" id="tbm-datetime" required></td>
                                </tr>
                                <tr>
                                    <th>작업명</th>
                                    <td colspan="3"><input type="text" id="tbm-work-name" placeholder="작업명 입력" required></td>
                                </tr>
                                <tr>
                                    <th>작업내용</th>
                                    <td colspan="3"><textarea id="tbm-work-details" placeholder="작업내용 입력" class="w-full border-none focus:ring-0 p-1" rows="2"></textarea></td>
                                </tr>
                                <tr>
                                    <th>TBM 장소</th>
                                    <td colspan="3"><input type="text" id="tbm-location" placeholder="장소 입력" required></td>
                                </tr>
                                <tr>
                                    <th rowspan="4">잠재위험요인</th>
                                    <td class="font-semibold bg-gray-100">위험성평가 실시여부</td>
                                    <td colspan="2">
                                        <label class="mr-2"><input type="radio" name="risk-assessment" value="yes"> 예</label>
                                        <label><input type="radio" name="risk-assessment" value="no" checked> 아니오</label>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="font-semibold bg-gray-100">잠재위험요인</td>
                                    <td class="font-semibold bg-gray-100" colspan="2">대책(※제거→대체→통제 순서 고려)</td>
                                </tr>
                                <tr class="risk-item">
                                    <td><input type="text" placeholder="위험요인 1"></td>
                                    <td colspan="2"><input type="text" placeholder="대책 1"></td>
                                </tr>
                                <tr class="risk-item">
                                    <td><input type="text" placeholder="위험요인 2"></td>
                                    <td colspan="2"><input type="text" placeholder="대책 2"></td>
                                </tr>
                                 <tr>
                                    <th>중점위험요인</th>
                                    <td colspan="3">
                                        <select id="tbm-key-risk" class="form-select">
                                            <option value="">선택하세요</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <th>TBM 리더 확인</th>
                                    <td colspan="3">
                                        <div class="grid grid-cols-3 gap-2 text-center">
                                            <input type="text" id="tbm-leader-dept" placeholder="소속">
                                            <input type="text" id="tbm-leader-position" placeholder="직책">
                                            <input type="text" id="tbm-leader-name" placeholder="성명(서명)">
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="mt-4">
                            <h4 class="font-bold mb-2">■ 참석자 확인</h4>
                             <table class="w-full border-collapse border border-gray-300 tbm-table">
                                <thead>
                                    <tr>
                                        <th>이름</th><th>서명</th><th>이름</th><th>서명</th>
                                    </tr>
                                </thead>
                                <tbody id="attendees-tbody">
                                    <tr>
                                        <td><input type="text"></td><td><input type="text"></td>
                                        <td><input type="text"></td><td><input type="text"></td>
                                    </tr>
                                     <tr>
                                        <td><input type="text"></td><td><input type="text"></td>
                                        <td><input type="text"></td><td><input type="text"></td>
                                    </tr>
                                </tbody>
                            </table>
                             <button type="button" id="add-attendee-btn" class="mt-2 text-sm text-blue-600 hover:underline">+ 참석자 추가</button>
                        </div>
                        
                        <div>
                            <label class="form-label" for="tbm-photo-upload">사진 첨부 (선택)</label>
                            <input type="file" id="tbm-photo-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>


                        <button type="submit" class="btn-primary">저장하기</button>
                     </form>
                </div>

                <!-- TBM 기록 목록 -->
                <div id="tbm-list-view" class="hidden">
                    <h3 class="text-xl font-bold mb-4">TBM 기록 목록</h3>
                    <div id="tbm-list" class="space-y-2">
                    </div>
                </div>

                <!-- TBM 기록 상세 보기 -->
                <div id="tbm-detail-view" class="hidden">
                     <button id="back-to-list-btn" class="btn-tertiary mb-4 w-auto">← 목록으로 돌아가기</button>
                    <div id="tbm-detail-content"></div>
                </div>
            </div>

            <!-- 커뮤니티 탭 -->
            <div id="community-content" class="tab-pane hidden">
                <div class="mb-6 card">
                    <h3 class="text-lg font-bold mb-4">익명 글쓰기</h3>
                    <form id="community-form" class="space-y-4">
                        <input type="text" id="community-nickname" placeholder="닉네임" class="form-input" required>
                        <textarea id="community-content-input" placeholder="내용을 자유롭게 작성해주세요." class="form-textarea" rows="4" required></textarea>
                        <button type="submit" class="btn-primary">게시하기</button>
                    </form>
                </div>
                <div id="community-list"></div>
            </div>

            <!-- 투표 탭 -->
            <div id="vote-content" class="tab-pane hidden">
                 <div class="mb-6">
                    <h3 class="text-lg font-bold mb-4">새 투표 만들기</h3>
                    <form id="vote-form" class="space-y-4">
                        <input type="text" id="vote-topic" placeholder="투표 주제" class="form-input" required>
                        <input type="text" id="vote-option1" placeholder="선택 1" class="form-input" required>
                        <input type="text" id="vote-option2" placeholder="선택 2" class="form-input" required>
                        <button type="submit" class="btn-primary">투표 생성</button>
                    </form>
                </div>
                <div id="vote-list"></div>
            </div>

            <!-- 미팅 탭 -->
            <div id="meeting-content" class="tab-pane hidden">
                <div class="mb-6">
                    <h3 class="text-lg font-bold mb-4">새 미팅 추가</h3>
                    <form id="meeting-form" class="space-y-4">
                        <input type="text" id="meeting-name" placeholder="회의명" class="form-input" required>
                        <input type="datetime-local" id="meeting-date" class="form-input" required>
                        <input type="url" id="meeting-link" placeholder="Zoom 링크" class="form-input" required>
                        <button type="submit" class="btn-primary">미팅 추가</button>
                    </form>
                </div>
                <div id="meeting-list"></div>
            </div>
        </main>
    </div>
    
    <!-- 로딩 스피너 -->
    <div id="loading-spinner" class="fixed inset-0 z-50 bg-white/70 flex items-center justify-center hidden">
        <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, arrayUnion, serverTimestamp, getDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        let db, auth, userId, companyCode, storage;
        let tbmRecordsCache = {}; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const listeners = []; 

        // DOM 요소
        const companyCodeModal = document.getElementById('company-code-modal');
        const appContainer = document.getElementById('app-container');
        const displayCompanyCode = document.getElementById('display-company-code');
        const changeCompanyBtn = document.getElementById('change-company-btn');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const loadingSpinner = document.getElementById('loading-spinner');

        const tbmFormView = document.getElementById('tbm-form-view');
        const tbmListView = document.getElementById('tbm-list-view');
        const tbmDetailView = document.getElementById('tbm-detail-view');
        const showTbmFormBtn = document.getElementById('show-tbm-form-btn');
        const showTbmListBtn = document.getElementById('show-tbm-list-btn');
        const backToListBtn = document.getElementById('back-to-list-btn');

        async function initializeAndAuth() {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                if (!firebaseConfig || !firebaseConfig.apiKey) throw new Error("Firebase 구성 정보가 필요합니다.");
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        checkCompanyCode();
                    }
                });
            } catch (e) {
                console.error(e.message);
                companyCodeModal.innerHTML = `<div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center"><h2 class="text-xl font-bold mb-4 text-red-600">설정 오류</h2><p class="text-gray-600 mb-6">앱 설정을 불러올 수 없습니다.</p></div>`;
            }
        }
        initializeAndAuth();

        function checkCompanyCode() {
            const savedCode = localStorage.getItem('tbmCompanyCode');
            if (savedCode) {
                companyCode = savedCode;
                startApp();
            } else {
                companyCodeModal.classList.remove('hidden');
                companyCodeModal.classList.add('flex');
            }
        }
        function startApp() {
            companyCodeModal.classList.add('hidden');
            appContainer.classList.remove('hidden');
            displayCompanyCode.textContent = `회사 코드: ${companyCode}`;
            fetchAllData();
        }
        function fetchAllData() {
            listeners.forEach(unsubscribe => unsubscribe());
            listeners.length = 0;
            loadTbmRecords();
            loadCommunityPosts();
            loadVotes();
            loadMeetings();
        }
        document.getElementById('company-code-submit').addEventListener('click', () => {
            const code = document.getElementById('company-code-input').value.trim();
            if (code) {
                localStorage.setItem('tbmCompanyCode', code);
                companyCode = code;
                startApp();
            } else { alert('회사 코드를 입력해주세요.'); }
        });
        changeCompanyBtn.addEventListener('click', () => {
            listeners.forEach(unsubscribe => unsubscribe());
            localStorage.removeItem('tbmCompanyCode');
            appContainer.classList.add('hidden');
            checkCompanyCode();
        });

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                tabPanes.forEach(pane => pane.classList.toggle('hidden', pane.id !== `${targetTab}-content`));
            });
        });
        
        function switchTbmView(viewToShow) {
            tbmFormView.classList.toggle('hidden', viewToShow !== 'form');
            tbmListView.classList.toggle('hidden', viewToShow !== 'list');
            tbmDetailView.classList.toggle('hidden', viewToShow !== 'detail');
            showTbmFormBtn.classList.toggle('btn-primary', viewToShow === 'form');
            showTbmFormBtn.classList.toggle('btn-tertiary', viewToShow !== 'form');
            showTbmListBtn.classList.toggle('btn-primary', ['list', 'detail'].includes(viewToShow));
            showTbmListBtn.classList.toggle('btn-tertiary', !['list', 'detail'].includes(viewToShow));
        }
        showTbmFormBtn.addEventListener('click', () => { document.getElementById('tbm-form').reset(); switchTbmView('form'); });
        showTbmListBtn.addEventListener('click', () => switchTbmView('list'));
        backToListBtn.addEventListener('click', () => switchTbmView('list'));

        function formatDate(timestamp) {
            if (!timestamp) return '';
            return timestamp.toDate().toLocaleString('ko-KR', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        function formatMeetingDate(isoString) {
            return new Date(isoString).toLocaleString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }
        
        // --- TBM 기록 로직 ---
        const tbmForm = document.getElementById('tbm-form');
        document.getElementById('add-attendee-btn').addEventListener('click', () => {
            document.getElementById('attendees-tbody').insertAdjacentHTML('beforeend', `<tr><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td><td><input type="text"></td></tr>`);
        });
        tbmForm.querySelectorAll('.risk-item input[placeholder^="위험요인"]').forEach(input => input.addEventListener('input', updateKeyRiskOptions));
        
        function updateKeyRiskOptions() {
            const keyRiskSelect = document.getElementById('tbm-key-risk');
            keyRiskSelect.innerHTML = '<option value="">선택하세요</option>';
            tbmForm.querySelectorAll('.risk-item input[placeholder^="위험요인"]').forEach((riskInput, index) => {
                if (riskInput.value.trim()) {
                    const option = new Option(`위험요인 ${index + 1}: ${riskInput.value}`, riskInput.value);
                    keyRiskSelect.add(option);
                }
            });
        }

        tbmForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingSpinner.classList.remove('hidden');

            let photoURL = '';
            const photoInput = document.getElementById('tbm-photo-upload');
            if (photoInput.files.length > 0) {
                const file = photoInput.files[0];
                const fileName = `${Date.now()}-${file.name}`;
                const storageRef = ref(storage, `artifacts/${appId}/public/images/${fileName}`);
                try {
                    await uploadBytes(storageRef, file);
                    photoURL = await getDownloadURL(storageRef);
                } catch (uploadError) {
                    console.error("사진 업로드 실패:", uploadError);
                    alert("사진 업로드에 실패했습니다.");
                    loadingSpinner.classList.add('hidden');
                    return;
                }
            }
            
            const risks = Array.from(document.querySelectorAll('.risk-item')).map(item => ({ risk: item.querySelector('input:first-child').value, measure: item.querySelector('input:last-child').value })).filter(r => r.risk || r.measure);
            const attendees = [];
            document.getElementById('attendees-tbody').querySelectorAll('tr').forEach(row => {
                const inputs = row.querySelectorAll('input');
                if(inputs[0].value || inputs[1].value) attendees.push({name: inputs[0].value, sign: inputs[1].value});
                if(inputs[2].value || inputs[3].value) attendees.push({name: inputs[2].value, sign: inputs[3].value});
            });

            const record = {
                companyCode, createdAt: serverTimestamp(),
                datetime: document.getElementById('tbm-datetime').value,
                workName: document.getElementById('tbm-work-name').value,
                workDetails: document.getElementById('tbm-work-details').value,
                location: document.getElementById('tbm-location').value,
                riskAssessment: document.querySelector('input[name="risk-assessment"]:checked').value,
                risks, keyRisk: document.getElementById('tbm-key-risk').value,
                leader: { dept: document.getElementById('tbm-leader-dept').value, position: document.getElementById('tbm-leader-position').value, name: document.getElementById('tbm-leader-name').value },
                attendees, photoLink: photoURL
            };
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/tbm_records`), record);
                tbmForm.reset();
                alert('TBM 회의록이 저장되었습니다.');
                switchTbmView('list');
            } catch (error) { console.error("TBM 기록 저장 실패:", error); alert("저장에 실패했습니다.");
            } finally { loadingSpinner.classList.add('hidden'); }
        });

        function loadTbmRecords() {
            const q = query(collection(db, `artifacts/${appId}/public/data/tbm_records`), where("companyCode", "==", companyCode));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const list = document.getElementById('tbm-list');
                list.innerHTML = '';
                tbmRecordsCache = {};
                const docs = snapshot.docs.sort((a, b) => new Date(b.data().datetime) - new Date(a.data().datetime));
                if (docs.length === 0) list.innerHTML = '<p class="text-gray-500 text-center py-4">아직 TBM 기록이 없습니다.</p>';
                docs.forEach(doc => {
                    const record = doc.data();
                    tbmRecordsCache[doc.id] = record;
                    const recordBtn = document.createElement('button');
                    recordBtn.className = "w-full text-left p-3 bg-white rounded-md shadow hover:bg-gray-50 transition";
                    recordBtn.innerHTML = `<span class="font-semibold text-blue-600">${record.workName}</span><span class="block text-sm text-gray-500">${formatMeetingDate(record.datetime)}</span>`;
                    recordBtn.onclick = () => showTbmDetail(doc.id);
                    list.appendChild(recordBtn);
                });
            }, (error) => console.error("TBM records listener error:", error));
            listeners.push(unsubscribe);
        }
        
        function showTbmDetail(recordId) {
            const record = tbmRecordsCache[recordId];
            if (!record) return;
            const risksHtml = record.risks.map(r => `<tr><td>${r.risk || ''}</td><td colspan="2">${r.measure || ''}</td></tr>`).join('');
            const attendeesHtml = record.attendees.map(a => `<tr><td>${a.name}</td><td>${a.sign}</td></tr>`).join('');
            document.getElementById('tbm-detail-content').innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-center">Tool Box Meeting 회의록</h3>
                <table class="w-full border-collapse border border-gray-300 tbm-table">
                     <tbody>
                        <tr><th>TBM 일시</th><td colspan="3">${formatMeetingDate(record.datetime)}</td></tr>
                        <tr><th>작업명</th><td colspan="3">${record.workName}</td></tr>
                        <tr><th>작업내용</th><td colspan="3">${record.workDetails.replace(/\n/g, '<br>')}</td></tr>
                        <tr><th>TBM 장소</th><td colspan="3">${record.location}</td></tr>
                        <tr><th rowspan="${2 + record.risks.length}">잠재위험요인</th><td class="font-semibold bg-gray-100">위험성평가</td><td colspan="2">${record.riskAssessment === 'yes' ? '예' : '아니오'}</td></tr>
                        <tr><td class="font-semibold bg-gray-100">잠재위험요인</td><td class="font-semibold bg-gray-100" colspan="2">대책</td></tr>
                        ${risksHtml}
                        <tr><th>중점위험요인</th><td colspan="3">${record.keyRisk}</td></tr>
                        <tr><th>TBM 리더 확인</th><td colspan="3"><div class="grid grid-cols-3 gap-2 text-center"><span>소속: ${record.leader.dept}</span><span>직책: ${record.leader.position}</span><span>성명: ${record.leader.name}</span></div></td></tr>
                    </tbody>
                </table>
                <div class="mt-4"><h4 class="font-bold mb-2">■ 참석자 확인</h4><table class="w-full border-collapse border border-gray-300 tbm-table"><thead><tr><th>이름</th><th>서명</th></tr></thead><tbody>${attendeesHtml}</tbody></table></div>
                ${record.photoLink ? `<div class="mt-4"><h4 class="font-bold mb-2">■ 첨부 사진</h4><a href="${record.photoLink}" target="_blank"><img src="${record.photoLink}" alt="TBM Photo" class="max-w-full h-auto rounded-md border"></a></div>` : ''}
            `;
            switchTbmView('detail');
        }

        // --- 커뮤니티, 투표, 미팅 로직 ---
        document.getElementById('community-form').addEventListener('submit', async(e) => { e.preventDefault(); loadingSpinner.classList.remove('hidden'); try { await addDoc(collection(db, `artifacts/${appId}/public/data/community_posts`), { companyCode, nickname: document.getElementById('community-nickname').value, content: document.getElementById('community-content-input').value, createdAt: serverTimestamp() }); e.target.reset(); } catch (error) { console.error("커뮤니티 글 게시 실패:", error); } finally { loadingSpinner.classList.add('hidden'); } });
        
        async function addComment(postId, nickname, text) {
            try { await addDoc(collection(db, `artifacts/${appId}/public/data/community_posts/${postId}/comments`), { nickname: nickname || "익명", text, createdAt: serverTimestamp() });
            } catch (error) { console.error("댓글 추가 실패:", error); }
        }

        function loadComments(postId) {
            const commentsContainer = document.getElementById(`comments-${postId}`);
            const q = query(collection(db, `artifacts/${appId}/public/data/community_posts/${postId}/comments`));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                if (!commentsContainer) return;
                commentsContainer.innerHTML = '';
                snapshot.docs.sort((a, b) => a.data().createdAt?.seconds - b.data().createdAt?.seconds).forEach(doc => {
                    const comment = doc.data();
                    const commentEl = document.createElement('div');
                    commentEl.className = "text-sm bg-gray-100 p-2 rounded-md";
                    commentEl.innerHTML = `<p><strong class="font-semibold">${comment.nickname}:</strong> ${comment.text}</p><p class="text-xs text-gray-400 text-right">${formatDate(comment.createdAt)}</p>`;
                    commentsContainer.appendChild(commentEl);
                });
            }, (error) => console.error(`Comments listener error for post ${postId}:`, error));
            listeners.push(unsubscribe);
        }

        function loadCommunityPosts() {
            const q = query(collection(db, `artifacts/${appId}/public/data/community_posts`), where("companyCode", "==", companyCode));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const list = document.getElementById('community-list');
                list.innerHTML = '';
                const docs = snapshot.docs.sort((a, b) => b.data().createdAt?.seconds - a.data().createdAt?.seconds);
                docs.forEach(doc => {
                    const post = doc.data();
                    const postId = doc.id;
                    const cardContainer = document.createElement('div');
                    cardContainer.innerHTML = `
                        <div class="card post-it">
                            <div class="flex justify-between items-start mb-2"><p class="font-bold text-lg">${post.nickname}</p><p class="text-xs text-gray-500">${formatDate(post.createdAt)}</p></div>
                            <p class="mb-2 whitespace-pre-wrap">${post.content}</p>
                            <div class="comment-section">
                                <div id="comments-${postId}" class="space-y-2 mb-2"></div>
                                <form class="comment-form space-y-2"><div class="flex space-x-2"><input type="text" placeholder="닉네임" class="form-input text-sm w-1/3"><input type="text" placeholder="댓글 달기..." class="form-input text-sm flex-grow" required></div><button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm w-full">게시</button></form>
                            </div>
                        </div>`;
                    list.appendChild(cardContainer);
                    cardContainer.querySelector('.comment-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const nickInput = e.target.querySelector('input[placeholder="닉네임"]'), textInput = e.target.querySelector('input[placeholder="댓글 달기..."]');
                        if (textInput.value.trim()) { addComment(postId, nickInput.value.trim(), textInput.value.trim()); nickInput.value = ''; textInput.value = ''; }
                    });
                    loadComments(postId);
                });
            }, (error) => console.error("Community posts listener error:", error));
            listeners.push(unsubscribe);
        }
        
        document.getElementById('vote-form').addEventListener('submit', async(e) => { e.preventDefault(); loadingSpinner.classList.remove('hidden'); try { await addDoc(collection(db, `artifacts/${appId}/public/data/votes`), { companyCode, topic: document.getElementById('vote-topic').value, option1: { text: document.getElementById('vote-option1').value, count: 0 }, option2: { text: document.getElementById('vote-option2').value, count: 0 }, voters: [], createdAt: serverTimestamp() }); e.target.reset(); } catch (error) { console.error("투표 생성 실패:", error); } finally { loadingSpinner.classList.add('hidden'); } });
        async function castVote(voteId, optionKey) { loadingSpinner.classList.remove('hidden'); const voteRef = doc(db, `artifacts/${appId}/public/data/votes`, voteId); try { const updateData = {}; updateData[`${optionKey}.count`] = increment(1); await updateDoc(voteRef, { ...updateData, voters: arrayUnion(userId) }); } catch (error) { console.error("투표 실패:", error); } finally { loadingSpinner.classList.add('hidden'); } }
        window.castVote = castVote;
        function loadVotes() { const q = query(collection(db, `artifacts/${appId}/public/data/votes`), where("companyCode", "==", companyCode)); const unsubscribe = onSnapshot(q, (snapshot) => { const list = document.getElementById('vote-list'); list.innerHTML = '<h3>진행중인 투표</h3>'; if (snapshot.empty) { list.innerHTML += '<p>진행중인 투표가 없습니다.</p>'; return; } snapshot.docs.sort((a, b) => b.data().createdAt?.seconds - a.data().createdAt?.seconds).forEach(docSnap => { const vote = docSnap.data(), voteId = docSnap.id, totalVotes = vote.option1.count + vote.option2.count; const p1 = totalVotes ? (vote.option1.count / totalVotes * 100).toFixed(1) : 0, p2 = totalVotes ? (vote.option2.count / totalVotes * 100).toFixed(1) : 0; const alreadyVoted = vote.voters.includes(userId); list.innerHTML += `<div class="card"><p class="font-bold">${vote.topic}</p><p class="text-xs">총 ${totalVotes}명 참여</p>${alreadyVoted ? `<div class="space-y-2 mt-2"><div class="w-full bg-gray-200 rounded-full h-8 relative"><div class="bg-blue-600 h-8 rounded-full text-white px-2 flex items-center" style="width:${p1}%">${vote.option1.text}</div><span class="absolute right-2 top-1/2 -translate-y-1/2">${vote.option1.count} (${p1}%)</span></div><div class="w-full bg-gray-200 rounded-full h-8 relative"><div class="bg-green-600 h-8 rounded-full text-white px-2 flex items-center" style="width:${p2}%">${vote.option2.text}</div><span class="absolute right-2 top-1/2 -translate-y-1/2">${vote.option2.count} (${p2}%)</span></div><p class="text-center text-sm">투표에 참여했습니다.</p></div>` : `<div class="flex space-x-4 mt-2"><button onclick="castVote('${voteId}','option1')" class="flex-1 btn-secondary">${vote.option1.text}</button><button onclick="castVote('${voteId}','option2')" class="flex-1 btn-secondary">${vote.option2.text}</button></div>`}</div>`; }); }, (error) => console.error("Votes listener error:", error)); listeners.push(unsubscribe); }
        document.getElementById('meeting-form').addEventListener('submit', async(e) => { e.preventDefault(); loadingSpinner.classList.remove('hidden'); try { await addDoc(collection(db, `artifacts/${appId}/public/data/meetings`), { companyCode, name: document.getElementById('meeting-name').value, date: document.getElementById('meeting-date').value, zoomLink: document.getElementById('meeting-link').value, }); e.target.reset(); } catch (error) { console.error("미팅 추가 실패:", error); } finally { loadingSpinner.classList.add('hidden'); } });
        function loadMeetings() { const q = query(collection(db, `artifacts/${appId}/public/data/meetings`), where("companyCode", "==", companyCode)); const unsubscribe = onSnapshot(q, (snapshot) => { const list = document.getElementById('meeting-list'); list.innerHTML = '<h3>예정된 미팅</h3>'; if (snapshot.empty) { list.innerHTML += '<p>예정된 미팅이 없습니다.</p>'; return; } snapshot.docs.sort((a, b) => new Date(a.data().date) - new Date(b.data().date)).forEach(doc => { const meeting = doc.data(); list.innerHTML += `<div class="card"><p class="font-bold">${meeting.name}</p><p>${formatMeetingDate(meeting.date)}</p><a href="${meeting.zoomLink}" target="_blank">Zoom 링크</a></div>`; }); }, (error) => console.error("Meetings listener error:", error)); listeners.push(unsubscribe); }
    </script>

</body>
</html>

